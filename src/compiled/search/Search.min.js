define(function(require){"use strict";var _=require("lodash"),React=require("react"),RequestHandler=require("RequestHandler"),$=require("jquery"),Search=React.createClass({displayName:"Search",propTypes:{url:React.PropTypes.string.isRequired,isFullDataResponse:React.PropTypes.bool,minLength:React.PropTypes.number,additionalFilters:React.PropTypes.object,searchFilterName:React.PropTypes.string,placeholder:React.PropTypes.string,onDataReceived:React.PropTypes.func,onSelect:React.PropTypes.func,onInputSubmit:React.PropTypes.func,rowFormatter:React.PropTypes.func},focusedIndex:null,actionOverList:!1,currentFilteredList:[],outstandingRequest:null,listKeyCodeHandlers:{38:"focusPrev",40:"focusNext",27:"clearList",13:"selectItemOnEnter"},cache:{},getDefaultProps:function(){return{isFullDataResponse:!1,minLength:2,placeholder:"Search"}},getInitialState:function(){return{disabled:this.props.isFullDataResponse,itemList:[],shownList:[],inputValue:"",inputFocused:!1}},componentDidMount:function(){this.props.isFullDataResponse&&this.requestFullData(),$(document).mouseup(_.bind(function(e){var container=$(".search-component");container.is(e.target)||0!==container.has(e.target).length||this.hideList()},this))},requestFullData:function(){RequestHandler.request(this.props.url,this.props.additionalFilters,this.onDataReceived,this.onError,this)},requestDataForTerm:function(searchTerm){var cachedData=this.cache[this.getSearchTermCacheKey(searchTerm)];if(cachedData)return void this.updateStateForNewData(cachedData);var searchFilter=this.props.additionalFilters||{};searchFilter[this.props.searchFilterName]=searchTerm,this.outstandingRequest&&this.outstandingRequest.abort&&this.outstandingRequest.abort(),this.outstandingRequest=RequestHandler.request(this.props.url,searchFilter,this.onDataReceived,this.onError,this)},onError:function(){this.props.isFullDataResponse&&this.setState({placeholder:"Unable to load list",disabled:!0})},onDataReceived:function(data){return data?(this.props.onDataReceived&&(data=this.props.onDataReceived(data,this.state.inputValue),this.setState({shownList:data})),!this.props.isFullDataResponse&&data.length&&data.sort(this.sortMatchingEntries),this.cache[this.getSearchTermCacheKey(this.state.inputValue)]=data,void this.updateStateForNewData(data)):void this.onError()},updateStateForNewData:function(data){var state={itemList:data,disabled:!1};this.props.isFullDataResponse||(state.shownList=data,this.currentFilteredList=data),this.setState(state)},getListOfMatchesForQuery:function(searchTerm){var matches=[];return searchTerm=searchTerm.toLowerCase().split(" ").join(""),_.forEach(this.state.itemList,function(item){var itemName=item.name.toLowerCase().split(" ").join(""),containsLocation=itemName.indexOf(searchTerm);containsLocation>-1&&(item.matchIndex=containsLocation,matches.push(item))}),matches.length&&matches.sort(this.sortMatchingEntries),matches},sortMatchingEntries:function(a,b){var aMatchIndex=a.matchIndex,bMatchIndex=b.matchIndex;return void 0===aMatchIndex&&void 0===bMatchIndex&&(aMatchIndex=a.secondaryMatchIndex,bMatchIndex=b.secondaryMatchIndex),void 0!==bMatchIndex&&void 0===aMatchIndex?1:void 0!==aMatchIndex&&void 0===bMatchIndex?-1:void 0===aMatchIndex&&void 0===bMatchIndex?0:aMatchIndex>bMatchIndex?1:bMatchIndex>aMatchIndex?-1:a.name.length>b.name.length?1:a.name.length<b.name.length?-1:a.name>b.name?1:a.name<b.name?-1:0},getSearchTermCacheKey:function(searchTerm){return _.trim(searchTerm.toLowerCase().replace(/\s{2,}/g," "))},onChange:function(event){var searchTerm=event.target.value;if(this.setState({inputValue:searchTerm}),searchTerm.length<this.props.minLength)this.currentFilteredList=[],this.setState({shownList:[]});else if(this.props.isFullDataResponse){var listToShow=this.getListOfMatchesForQuery(searchTerm);this.currentFilteredList=listToShow,this.setState({shownList:listToShow})}else this.requestDataForTerm(searchTerm)},onFocus:function(){this.focusedIndex=null,this.setState({shownList:this.currentFilteredList,inputFocused:!0})},onBlur:function(){this.actionOverList||this.hideList()},onInputKeyPress:function(event){!event.keyCode||40!==event.keyCode&&27!==event.keyCode&&13!==event.keyCode||(event.preventDefault(),40===event.keyCode?this.focusNext():(13===event.keyCode&&this.props.onInputSubmit&&this.props.onInputSubmit(this.state.inputValue),this.currentFilteredList=[],this.setState({shownList:[],inputValue:""})))},onListKeyPress:function(event){var handler=this.listKeyCodeHandlers[event.keyCode];handler&&this[handler]&&(event.preventDefault(),this[handler]())},focusNext:function(){var index=this.focusedIndex;this.focusOnItemAtIndex(null===index?0:++index)},focusPrev:function(){var index=this.focusedIndex;null!==index&&(0===index?this.refs.searchInput.getDOMNode().focus():this.focusOnItemAtIndex(--index))},focusOnItemAtIndex:function(index){var list=this.refs.list.getDOMNode().childNodes;index>-1&&index<list.length&&(this.focusedIndex=index,this.actionOverList=!0,list[index].focus())},clearList:function(clearFocus){this.actionOverList=!1,this.currentFilteredList=[],this.setState({inputValue:""}),this.hideList(),clearFocus||this.refs.searchInput.getDOMNode().focus()},hideList:function(){this.focusedIndex=null,(this.state.shownList.length||this.state.inputFocused)&&this.setState({shownList:[],inputFocused:!1})},selectItemOnEnter:function(){var selectedItem=this.refs.list.getDOMNode().childNodes[this.focusedIndex];this.itemSelect({target:selectedItem})},itemSelect:function(event){this.props.onSelect&&this.props.onSelect(event,this.state.inputValue),this.clearList(!0)},handleListMouseEnter:function(event){this.actionOverList=!0,event.target.focus(),_.forEach(this.refs.list.getDOMNode().childNodes,_.bind(function(child,index){child===event.target&&(this.focusedIndex=index)},this))},handleListMouseLeave:function(){this.actionOverList=!1},getAutocompleteComponents:function(rowData){var markup=[];return _.forEach(rowData,_.bind(function(item){markup.push(React.createElement("li",{key:item.id,"data-id":item.id,tabIndex:"-1",onMouseEnter:this.handleListMouseEnter},item.name))},this)),markup},render:function(){var autoCompleteMarkup=(this.props.rowFormatter||this.getAutocompleteComponents)(this.state.shownList,this.handleListMouseEnter),searchIconClasses=React.addons.classSet({fa:!0,"fa-search":!0,focused:this.state.inputFocused}),placeholderText=this.state.itemList?this.props.placeholder:"Loading...";return React.createElement("div",{className:"search-component"},React.createElement("div",{className:"input-group"},React.createElement("i",{className:searchIconClasses}),React.createElement("input",{ref:"searchInput",value:this.state.inputValue,type:"text",autoComplete:"off",placeholder:placeholderText,disabled:this.state.disabled,onChange:this.onChange,onFocus:this.onFocus,onBlur:this.onBlur,onKeyDown:this.onInputKeyPress}),React.createElement("ul",{ref:"list",className:"autocomplete-list",onClick:this.itemSelect,onMouseLeave:this.handleListMouseLeave,onKeyDown:this.onListKeyPress},autoCompleteMarkup)))}});return Search});
